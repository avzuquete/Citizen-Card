# Linux wrapper for the Portuguese Citizen card PKCS #11 library

This project creates a Linux wrapper library for intercepting all calls to the PKCS #11 library designed to manipulate the Portuguese eID token (Cartão de Cidadão, Citizen Card).

## Generation details

The Makefile defines the library to wrap (default: /usr/local/lib/libpteidpkcs11.so).
The wrapping library will use it by default (referred by the C constant DEFAULT_LIB_PATH).
This can be dynamically overwritten with an environment variable named PTEIDPKCS11_WRAPPER.

The Makefile gets the PKCS #11 interface from the standard definition files (located in https://docs.oasis-open.org/pkcs11/pkcs11-base/v3.0/os/include/pkcs11-v3.0)

The default interceptors are generated automatically (api.c) and just print the function name before calling the original function.

PKCS #11 functions not implemented by the wrapped library are not intercepted (nor defined in the wrapper).

The function that lists the implemented functions (C_GetFunctionList) works properly (returns the pointers to the interceptors).

## Evolution of the original wrapping functions

The default interceptors can be adapted to perform other operations. The file api.c, once created, is not overwritten by the Makefile execution, unless upon an update of the wrapped library.  Therefore, modified interceptors should be stored in a different file to avoid loosing work.

# Commands

```
$ make          # for generating the wrapper (pkcs11.so)
$ make clean    # for cleaning files automatically generated by the Makefile
```
